
## Streaming Toy Detector Plugin

### Overview

The toy detector (toyDet) plugin facilitates both the online and offline analysis of streaming data. Simulated data 
is generated by the `toyDet.py` script which produces a flat text (data) file.  The format of the simulated data is 
available in a variety of formats and is discussed in further detail below.

Moreover, The `toyDet` JANA2 plugin facilitates the decoding of streaming data by either reading from the 
file directly or by subscribing to ZMQ messages published in the INDRA Messaging format which is discussed 
in further detail below. The plugin decodes streaming data and produces a ROOT file `outFile.root` which 
contains leaves with the corresponding ADC and TDC data.  In addition, the plugin can publish INDRA ZMQ 
messages so that the data can be monitored interactively and in real time via a Jupyter Notebook whose 
infrastructure is contained in the `jupyter` sub directory.  Further details of the underlying infrastructure 
is discussed below.

### Simulating Streaming Data toyDet.py

The streaming ADC data are assumed to emanate from a single SAMPA chip sampling 80 streams of ADC data at 
5 MhZ (200 ns / sample). Each readout window is comprised of 1024 ADC samples (204.8 $`us`$ / readout window).  
An "event is defined to be a single readout window. The simulated ADC data is a sampled analog signal 
whose distribution is governed by a fourth order semi-Gaussian which is inherent to the charge shaping 
amplifier present in the SAMPA chip signal processing architecture.  The pulse amplitude of the distribution 
is randomized for each pulse so that the full dynamic range (10-bit, 1024 channels) of the ADC is populated. 
Moreover, the time in which the signal occurs in the readout window is randomized such that it can occur at any 
location in time in side the 204.8 $`us`$ window however, it is prohibited to occur within the first 25% and 
last 25% of the samples withing the readout window.  

| Parameter (short) | Parameter (long) | Description                                                | Suggested Value | Required? |
| ----------------- | ---------------- | ---------------------------------------------------------- | --------------- | --------- |
| -sr               | --sampleRate     | Sampling rate in MHz of the SAMPA chips (5, 10, or 20 MHZ) | 5               | true      |
| -nc               | --numChans       | Number of channels to simulate ADC data for                | 80              | true      |
| -ne               | --numEvents      | Number of events to simulate for each channel              | 100             | true      |
| -spec             | --spectra        | ADC spectra to simulate (gumbel or sampa)                  | sampa           | true      |
| -m                | --mode           | SAMPA DAQ mode to simulate (das or dsp)                    | das             | false     |

Example usage for default behavior is as follows:

```
python toyDet.py -sr 5 -nc 80 -ne 100 -spec sampa -m das
```

Upon execution the data file `run-5-mhz-80-chan-100-ev.dat` will have been created in the present working directory.
Each column of the data file corresponds to a single ADC channel and each row corresponds to the ADC sample value 
for each of the 80 channels that were readout.

### Compiling

A few software prerequisites are required in order to successfully build and execute the toy detector plugin. 
They are the following :

1. The minimum required version of cmake is 3.13
1. ROOT must be installed and the appropriate environment configured
    - `source /path/to/root/installation/bin/thisroot.(c)sh`
    - Manually configure the `ROOTSYS, PATH,` and `LD_LIBRARY_PATH` environment variables
1. Both the ZeroMQ and CZMQ libraries must be present
    - Use your package manager to install the libraries system wide e.g. `yum install zeromq-devel` 
    and `yum install czmq-devel` 

In order to compile JANA2 in conjunction with the toy detector plugin, one must execute the following commands:

```
git clone git@gitlab.com:indra-astra/JANA2.git
cd JANA2
cmake . .
make -j4
``` 

### Configuring the JANA2 Environment

Two environment variables are required for executing JANA2.  In bash one should execute the following commands :

```
export JANA_HOME=/path/to/JANA2/
export JANA_PLUGIN_PATH=$JANA_HOME
export PATH=$PATH:$JANA_HOME 
```

### Plugin Components

The various classes that comprise the toy detector plugin are described in the following subsections

#### ADCSample

The class `ADCSample` defines the components, and their associated data types, of ADC sample data as a JObject.  
The components of the ADC data as a JObject are defined in the following table:

| Object Name | Data Type | Description                                                               |
| ----------- | --------- | ------------------------------------------------------------------------- | 
| source_id   | uint16_t  | 32-bit identifier governed by the INDRA message format                    |
| channel_id  | uint16_t  | Channel number corresponding to the ADC sample                            |
| sample_id   | uint16_t  | Sample number corresponding to the ADC sample (analogous to a TDC sample) |
| adc_value   | uint16_t  | Value of the ADC sample                                                   |

#### ADCSampleFactory



#### DASFileSource

#### INDRAMessage

#### JFactoryGenerator

#### MonitoringProcessor

#### RootProcessor

#### toyDet

#### ZMQTransport

### Plugin Parameters

Below the various parameters of the `toyDet` plugin are displayed as well as their default values.

| Parameter                  | Description                                                                          | Default Value                |
| -------------------------- | ------------------------------------------------------------------------------------ | ---------------------------- |
| toydet:use_zmq             | Subscribe to ZMQ messages?                                                           | true                         |
| toydet:data_file           | Name of data file to read if toydet:use_dummy_publisher == true                      | run-5-mhz-80-chan-100-ev.dat |
| toydet:use_dummy_publisher | Reads from toydet:data_file file and publishes ZMQ messages for JANA to subscribe to | false                        |
| toydet:nchannels           | Number of channels in data stream                                                    | 80                           |
| toydet:nsamples            | Number of samples in data stream                                                     | 1024                         |
| toydet:msg_print_freq      | Frequency at which information should be printed to screen during analysis           | 10                           |
| toydet:sub_socket          | ZMQ subscribing socket                                                               | tcp://127.0.0.1:5556         |
| toydet:pub_socket          | ZMQ publishing socket                                                                | tcp://127.0.0.1:5557         |
| toydet:rawhit_ms           | Simulate delay in processing time (ms)                                               | 200                          |
| toydet:rawhit_spread       | Spread in simulated delay in processing time (sigma)                                 | 0.25                         |

### Executing the Toy Detector Plugin

The toy detector can operate in two functional modes.  One mode utilizes a dummy publisher to read a flat text from 
disk and then creates a ROOT file and publishes INDRA messages via. ZMQ.  The following command will read the data 
file `run-5-mhz-80-chan-100-ev.dat`, produce a ROOT file `outFile.root`, and publish the data as a INDRA ZMQ  
message on the socket `tcp://127.0.0.1:5557`:

```
jana -Pplugins=toyDet -Ptoydet:use_dummy_publisher=1 -Ptoydet:pub_socket=tcp://127.0.0.1:5557
```

In the alternate mode JANA2 subscribes to INDRA messages via. ZMQ and creates a ROOT file `outFile.root` as well as 
publishes those messages via ZMQ for online monitoring purposes.  The following command will receive INDRA ZMQ 
messages on socket `tcp://127.0.0.1:5556` and publish them on socket `tcp://127.0.0.1:5557`.

```
jana -Pplugins=toyDet -Ptoydet:use_dummy_publisher=0 -Ptoydet:sub_socket=tcp://127.0.0.1:5556 -Ptoydet:pub_socket=tcp://127.0.0.1:5557
```

### Publishing ZMQ INDRA Messages via INDRA_Stream_Test



### Online Monitoring via Jupyter Notebook




